<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>elk用户认证问题 | chris&#39;wang</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://chriswsq.github.io/favicon.ico?v=1617783366892">
<link rel="stylesheet" href="https://chriswsq.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="elk7+的用户认证免费了，不过没有集成在安装包里，还需要自己再进行一些操作，在此记录下自己再配置用户认证时遇到的问题

开启安全功能
首先在es配置文件中开启安全功能
.....

xpack.security.enabled: true..." />
    <meta name="keywords" content="ELK" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://chriswsq.github.io">
        <img src="https://chriswsq.github.io/images/avatar.png?v=1617783366892" class="site-logo">
        <h1 class="site-title">chris&#39;wang</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      当你觉得无所事事时，那你就是在虚度光阴
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://chriswsq.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">elk用户认证问题</h2>
            <div class="post-date">2020-08-27</div>
            
            <div class="post-content" v-pre>
              <p>elk7+的用户认证免费了，不过没有集成在安装包里，还需要自己再进行一些操作，在此记录下自己再配置用户认证时遇到的问题</p>
<!-- more -->
<h2 id="开启安全功能">开启安全功能</h2>
<p>首先在es配置文件中开启安全功能</p>
<pre><code>.....

xpack.security.enabled: true
xpack.security.transport.ssl.enabled
</code></pre>
<p>然后重启es服务</p>
<h2 id="生成证书配置node间ssl通信">生成证书，配置Node间SSL通信</h2>
<h3 id="创建ca证书">创建ca证书</h3>
<pre><code>$ bin/elasticsearch-certutil ca -v
</code></pre>
<p>一路回车即可</p>
<p>默认的CA证书存放在$ES_HOME 目录中</p>
<p>这个命令生成格式为PKCS#12名称为 elastic-stack-ca.p12 的keystore文件，包含CA证书和私钥。</p>
<h3 id="创建节点间认证用的证书">创建节点间认证用的证书</h3>
<pre><code>$ ./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 
</code></pre>
<p>一路回车即可</p>
<h3 id="配置es节点使用这个证书">配置ES节点使用这个证书</h3>
<pre><code>$ mkdir config/certs
$ mv elastic-* config/certs/
ll config/certs/

-rw------- 1 elasticsearch root 3443 Jun  9 15:22 elastic-certificates.p12
-rw------- 1 elasticsearch root 2527 Jun  9 15:22 elastic-stack-ca.p12
</code></pre>
<p>拷贝这个目录到所有的ES节点中<br>
config/certs 目录中不需要拷贝CA证书文件，只拷贝cert文件即可</p>
<p>配置elasticsearch.yml配置文件，注意所有的node节点都需要配置，这里的配置是使用PKCS#12格式的证书。</p>
<pre><code>$ vim  config/elasticsearch.yml
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate #认证方式使用证书
xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12
</code></pre>
<h2 id="测试能够正常启动了-好了我们再来继续之前的生成密码在随意一台节点即可">测试能够正常启动了。好了，我们再来继续之前的生成密码：在随意一台节点即可。</h2>
<p>生成密码有两个命令，一个为自动生成，一个为手动生成</p>
<p>自动<br>
<code>bin/elasticsearch-setup-passwords auto</code><br>
手动<br>
<code>bin/elasticsearch-setup-passwords interactive</code></p>
<p>这里我们选择自动</p>
<pre><code>[root@elasticsearch1 elasticsearch]# bin/elasticsearch-setup-passwords auto
Initiating the setup of passwords for reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.
The passwords will be randomly generated and printed to the console.
Please confirm that you would like to continue [y/N]y


Changed password for user apm_system
PASSWORD apm_system = EKPbqziKu4v3P0MYoYIJ

Changed password for user kibana
PASSWORD kibana = 48Sf7tIFArn4rmyMW2x4

Changed password for user logstash_system
PASSWORD logstash_system = O09XtxP495uNRxHRZxtC

Changed password for user beats_system
PASSWORD beats_system = ULC810uP0sVCAKhbwxvE

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = zqnO9YBFsoRu5QIsgOi6

Changed password for user elastic
PASSWORD elastic = d27DuDQjTChIdv3sE8oI

</code></pre>
<p>查看集群节点数量：</p>
<pre><code>[root@test-1 conf]# curl -u elastic 192.168.154.6:9200/_cat/nodes
Enter host password for user 'elastic':
10.0.0.67 32 88 1 0.12 0.08 0.43 ilmr   - node-1
10.0.0.92 14 80 1 0.12 0.07 0.22 dilmrt * node-2
10.0.0.93 12 79 1 0.00 0.03 0.24 dilmrt - node-3
</code></pre>
<h2 id="kibana的安装配置">kibana的安装配置</h2>
<h3 id="编辑配置文件">编辑配置文件</h3>
<pre><code>$ cat kibana/config/kibana.yml |grep -Ev &quot;^$|^#&quot;
server.port: 5601
server.host: &quot;0.0.0.0&quot;
server.name: &quot;mykibana&quot;
elasticsearch.hosts: [&quot;http://localhost:9200&quot;]
kibana.index: &quot;.kibana&quot;
elasticsearch.username: &quot;kibana&quot;
elasticsearch.password: &quot;UKuHceHWudloJk9NvHlX&quot;
# i18n.locale: &quot;en&quot;
i18n.locale: &quot;zh-CN&quot;
xpack.security.encryptionKey: Hz*9yFFaPejHvCkhT*ddNx%WsBgxVSCQ
</code></pre>
<h3 id="页面访问kibana">页面访问kibana</h3>
<figure data-type="image" tabindex="1"><img src="/images/elk%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/kibana-login.jpg" alt="" loading="lazy"></figure>
<p>输入上面生成的管理员elastic的用户和密码，就可以登陆了，我们查看一下license许可吧：<br>
<img src="/images/elk%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/kibana-basic.jpg" alt="" loading="lazy"></p>
<p>一个使用永不过期的Basic许可的免费License，开启了基本的Auth认证和集群间SSL/TLS 认证的Elasticsearch集群就创建完毕了。</p>
<p>等等，你有没有想过Kibana的配置文件中使用着明文的用户名密码，这里只能通过LInux的权限进行控制了，有没有更安全的方式呢，有的，就是keystore。</p>
<h3 id="kibana-keystore-安全配置">kibana keystore 安全配置</h3>
<p><a href="https://www.elastic.co/guide/en/kibana/7.7/secure-settings.html">参考官方</a></p>
<p>查看<code>kibana-keystore</code>命令帮助：</p>
<pre><code>$ ./bin/kibana-keystore --help
Usage: bin/kibana-keystore [options] [command]

A tool for managing settings stored in the Kibana keystore

Options:
  -V, --version           output the version number
  -h, --help              output usage information

Commands:
  create [options]        Creates a new Kibana keystore
  list [options]          List entries in the keystore
  add [options] &lt;key&gt;     Add a string setting to the keystore
  remove [options] &lt;key&gt;  Remove a setting from the keystore

</code></pre>
<p>首先我们创建keystore：</p>
<pre><code>$ bin/kibana-keystore create
Created Kibana keystore in /opt/elk74/kibana-7.4.2-linux-x86_64/data/kibana.keystore # 默认存放位置
</code></pre>
<p>增加配置：</p>
<p>我们要吧kibana.yml 配置文件中的敏感信息，比如：elasticsearch.username 和 elasticsearch.password，给隐藏掉，或者直接去掉；</p>
<p>所以这里我们增加两个配置：分别是elasticsearch.password 和 elasticsearch.username:</p>
<pre><code># 查看add的命令帮助：
$ ./bin/kibana-keystore add --help
Usage: add [options] &lt;key&gt;

Add a string setting to the keystore

Options:
  -f, --force   overwrite existing setting without prompting
  -x, --stdin   read setting value from stdin
  -s, --silent  prevent all logging
  -h, --help    output usage information

# 创建elasticsearch.username这个key：注意名字必须是kibana.yml中的key
$ ./bin/kibana-keystore add elasticsearch.username
Enter value for elasticsearch.username: ******  # 输入key对应的value，这里是kibana连接es的账号：kibana

# 创建elasticsearch.password这个key
$ ./bin/kibana-keystore add elasticsearch.password
Enter value for elasticsearch.password: ******************** # 输入对应的密码：UKuHceHWudloJk9NvHlX
</code></pre>
<p>好了，我们把kibana.yml配置文件中的这两项配置删除即可，然后直接启动kibana，kibana会自动已用这两个配置的。</p>
<p>最终的kibana.yml配置如下：</p>
<pre><code>server.port: 5601
server.host: &quot;0.0.0.0&quot;
server.name: &quot;mykibana&quot;
elasticsearch.hosts: [&quot;http://localhost:9200&quot;]
kibana.index: &quot;.kibana&quot;
# i18n.locale: &quot;en&quot;
i18n.locale: &quot;zh-CN&quot;
xpack.security.encryptionKey: Hz*9yFFaPejHvCkhT*ddNx%WsBgxVSCQ
</code></pre>
<p>这样配置文件中就不会出现敏感信息了，达到了更高的安全性。</p>
<p>类似的Keystore方式不只是Kibana支持，ELK的产品都是支持的。</p>
<p><strong>注意：两个证书文件属主须是启动用户，certs权限为744即可，权限不够会报错,其他节点权限也一样</strong></p>
<pre><code>elk_elasticsearch1.1.rqtnwnm1sqzw@test-1    | uncaught exception in thread [main]
elk_elasticsearch1.1.rqtnwnm1sqzw@test-1    | ElasticsearchSecurityException[failed to load SSL configuration [xpack.security.transport.ssl]]; nested: ElasticsearchException[failed to initialize SSL TrustManager - not permitted to read truststore file [/usr/share/elasticsearch/config/certs/elastic-certificates.p12]]; nested: AccessDeniedException[/usr/share/elasticsearch/config/certs/elastic-certificates.p12];
elk_elasticsearch1.1.jp9k598g34hq@test-1    | &quot;... 6 more&quot;] }
elk_elasticsearch1.1.yk71h6aom47z@test-1    | &quot;at org.elasticsearch.node.Node.&lt;init&gt;(Node.java:481) ~[elasticsearch-7.7.0.jar:7.7.0]&quot;,
elk_elasticsearch1.1.w26656n32a86@test-1    | &quot;... 6 more&quot;] }
elk_elasticsearch1.1.w26656n32a86@test-1    | ElasticsearchSecurityException[failed to load SSL configuration [xpack.security.transport.ssl]]; nested: ElasticsearchException[failed to initialize SSL TrustManager - not permitted to read truststore file [/usr/share/elasticsearch/config/certs/elastic-certificates.p12]]; nested: AccessDeniedException[/usr/share/elasticsearch/config/certs/elastic-certificates.p12];
elk_elasticsearch1.1.rqtnwnm1sqzw@test-1    | Likely root cause: java.nio.file.AccessDeniedException: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
elk_elasticsearch1.1.jp9k598g34hq@test-1    | ElasticsearchSecurityException[failed to load SSL configuration [xpack.security.transport.ssl]]; nested: ElasticsearchException[failed to initialize SSL TrustManager - not permitted to read truststore file [/usr/share/elasticsearch/config/certs/elastic-certificates.p12]]; nested: AccessDeniedException[/usr/share/elasticsearch/config/certs/elastic-certificates.p12];
</code></pre>
<p><a href="https://knner.wang/2019/11/26/install-elasticsearch-cluster-7-4.html">参考自</a></p>
<h2 id="logstash配置">logstash配置</h2>
<p><a href="https://www.elastic.co/cn/blog/configuring-ssl-tls-and-https-to-secure-elasticsearch-kibana-beats-and-logstash">参考</a></p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://chriswsq.github.io/tag/Nqh1b7Zat/" class="tag">
                    ELK
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://chriswsq.github.io/post/elk-gao-jing-zhi-elastalert-bu-shu-ji-pei-zhi/">
                  <h3 class="post-title">
                    ELK告警之elastalert部署及配置
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
