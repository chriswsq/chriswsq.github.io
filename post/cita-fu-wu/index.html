<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>cita服务 | chris&#39;wang</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://chriswsq.github.io/favicon.ico?v=1608887271599">
<link rel="stylesheet" href="https://chriswsq.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="根据公司需求研究部署cita服务

关于 CITA
CITA 是一个面向企业级应用的支持智能合约的高性能区块链内核， 旨在为企业级区块链应用提供一个稳固、高效、灵活、可适应未来的运行平台。 CITA 将区块链节点的必要功能解耦为六个微服务：..." />
    <meta name="keywords" content="cita" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://chriswsq.github.io">
        <img src="https://chriswsq.github.io/images/avatar.png?v=1608887271599" class="site-logo">
        <h1 class="site-title">chris&#39;wang</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      当你觉得无所事事时，那你就是在虚度光阴
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://chriswsq.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">cita服务</h2>
            <div class="post-date">2020-08-25</div>
            
            <div class="post-content" v-pre>
              <p>根据公司需求研究部署cita服务</p>
<!-- more -->
<h2 id="关于-cita">关于 CITA</h2>
<p>CITA 是一个面向企业级应用的支持智能合约的高性能区块链内核， 旨在为企业级区块链应用提供一个稳固、高效、灵活、可适应未来的运行平台。 CITA 将区块链节点的必要功能解耦为六个微服务：RPC，Auth，Consensus，Chain，Executor，Network。各组件之间通过消息总线交换信息相互协作。 通过配置和定制相应的服务，CITA 能够满足企业级用户的全部需要。</p>
<p>基础环境<br>
docker、docker-compose<br>
部署方式<br>
docker-compose<br>
镜像版本<br>
cita/cita-release:20.2.0-sm2-sm3</p>
<blockquote>
<p>注意<br>
必选配置项有 super_admin 和 nodes，系统不提供默认配置。</p>
</blockquote>
<h2 id="安装-cita-客户端工具">安装 CITA 客户端工具</h2>
<ol>
<li>创建目录</li>
</ol>
<p><code>mkdir -p /bsn/cita</code><br>
2. 切换目录</p>
<p><code>cd /bsn/cita</code><br>
3. 下载 CITA-CLI 安装包</p>
<pre><code class="language-bash">wget https://github.com/citahub/cita-cli/releases/download/20.2.2/cita-cli-x86_64-musl-tls-20.2.2.tar.gz
</code></pre>
<ol start="4">
<li>解压程序</li>
</ol>
<p><code>tar zxvf cita-cli-x86_64-musl-tls-20.2.2.tar.gz</code><br>
5. 复制 CITA-CLI 到 系统可执行文件目录下</p>
<p><code>cp -rp cita-cli /usr/local/bin/</code><br>
<code>./cita-cli</code></p>
<h3 id="查看当前所在的链和加密算法">查看当前所在的链和加密算法</h3>
<p><code>cita&gt; info</code></p>
<p>输出结果：</p>
<blockquote>
<ul>
<li>url : 当前所在的链</li>
<li>encryption : 加密算法</li>
</ul>
</blockquote>
<pre><code class="language-bash">[       url        ]: http://127.0.0.1:1337
[       pwd        ]: /Users/yanli/soft/CITA/toolcita
[      color       ]: true
[      debug       ]: true
[       json       ]: true
[    encryption    ]: secp256k1
[ completion_style ]: List
[    edit_style    ]: Vi
[   save_private   ]: true
</code></pre>
<p>切换链<br>
<code>cita&gt; switch --url https://testnet.citahub.com</code></p>
<p>切换加密算法<br>
<code>cita&gt; switch --algorithm --help</code></p>
<p>输出结果：</p>
<pre><code class="language-bash">&gt;&gt; switch 
Switch environment variables, such as url/algorithm

USAGE:
    switch [FLAGS] [OPTIONS]

FLAGS:
        --color               Switching color for rpc interface
        --debug               Switching debug mode
        --json                Switching json format
        --completion_style    Switching completion style
        --edit_style          Switching edit style
        --save_private        Switching whether save private key
    -h, --help                Prints help information

OPTIONS:
        --url &lt;url&gt;                Switch url
        --algorithm &lt;algorithm&gt;    Select the encryption algorithm you want, the default is secp256k1 [possible values:
                                   secp256k1, ed25519, sm2]

</code></pre>
<p>如：切换至 sm2 加密算法<br>
<code>cita&gt; switch --algorithm sm2</code></p>
<h3 id="创建超级管理员账户地址-私钥-公钥">创建超级管理员账户地址、私钥、公钥</h3>
<p>执行命令：<br>
<code>cita&gt; key create</code></p>
<p>命令返回：</p>
<pre><code class="language-bash">{
  &quot;address&quot;: &quot;0xbac32b0a26bb3380e3f1a8b99af8f32922708730&quot;,
  &quot;private&quot;: &quot;0x7664a098547142fdf7fc3a732607f707512f98df4d6b7040f009858813e257d5&quot;,
  &quot;public&quot;: &quot;0x91f9dad655d7ccec4830fa036b0e5311c995acf960bc84df901f54fd232060b99fbc2672d64075263d0f4f4b0d50b1ddf6c22bc9b402626dfa726b2d532918b0&quot;
}

</code></pre>
<blockquote>
<p>注：此处为示例公私钥对，不要在生产环境复制使用，其中：</p>
</blockquote>
<blockquote>
<ul>
<li>&quot;address&quot;： 账户地址</li>
<li>&quot;private&quot;：账户私钥</li>
<li>&quot;public&quot;：账户公钥</li>
</ul>
</blockquote>
<h2 id="docker-compose-部署cita服务">docker-compose 部署cita服务</h2>
<h3 id="1-生成节点配置文件">1. 生成节点配置文件</h3>
<p>docker-compose-conf.yml</p>
<pre><code class="language-yml">version: '3'
networks:
  main:

services:
  config:
    container_name: config
    environment:
      - SUPER_ADMIN=0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523
      - NODES_CONFIG=192.168.40.6:4000,192.168.40.7:4000,192.168.40.8
    image: cita/cita-release:20.2.0-sm2-sm3
    hostname: config
    networks:
      main:
        aliases:
          - config
    volumes:
      - ./:/opt/cita-run
    command: |
      bash -c '
      echo &quot;Create config files...&quot;;
      cita create --super_admin &quot;$$SUPER_ADMIN&quot; --nodes &quot;$$NODES_CONFIG&quot;;
      echo &quot;Done config&quot;'
</code></pre>
<pre><code class="language-bash">docker create network main
docker-compose -f  docker-compose-conf.yml
</code></pre>
<p>创建 3 个共识节点的目录结构如下:</p>
<pre><code class="language-bash">$ ls test-chain/
0 1 2  template
$ ls 0
address     consensus.toml  forever.toml       logs
auth.toml   data            genesis.json       network.toml
chain.toml  executor.toml   jsonrpc.toml       privkey
</code></pre>
<p>将配置文件拷贝到其他节点</p>
<ul>
<li>privkey : 存放私钥</li>
<li>address : 存放地址</li>
<li>*.toml : 各个微服务配置文件，详细说明见微服务说明</li>
<li>genesis.json ： 生成 genesis 块文件， 其中 timestamp 为时间戳，秒为单位；prevhash -指前一个块哈希，这里是默认值；而 alloc 指部署到创世块的合约内容；</li>
<li>test-chain/template 目录下是模板文件，包括这个链的共识节点地址 test-chain/template/- authorities.list，系统参数 test-chain/template/init_data.yml, 节点端口地址 test-chain/template/nodes.list 等信息</li>
<li>logs : 记录链运行的日志信息</li>
<li>data : 数据存储</li>
</ul>
<p>CITA有一些保留端口，设置节点网络端口，或者自定义端口的时候要避免产生端口冲突。保留端口有：<br>
默认的 jsonrpc 端口：1337 到 1337 + N<br>
默认的 websocket 端口：4337 到 4337+N<br>
因为我们是不同的机器所以不用担心端口冲突的问题，可以修改jsonrpc.toml文件上面两个端口为一致</p>
<h3 id="2-节点部署文件">2. 节点部署文件</h3>
<p>node-1节点文件<br>
docker-compose-node0.yml</p>
<pre><code class="language-yml">version: '3'
networks:
  main:

  services:
    node0:
    container_name: node0
    image: cita/cita-release:20.2.0-sm2-sm3
    hostname: node0
    networks:
      main:
        aliases:
          - node0
    volumes:
      - ./:/opt/cita-run
    ports:
      - &quot;1337:1337&quot;
    command: |
      bash -c '
      while [[ ! -d /opt/cita-run/test-chain ]]; do sleep 1; done;
      sleep 10;
      cita setup test-chain/0;
      cita start test-chain/0;
      sleep infinity'
</code></pre>
<p>node-2节点文件<br>
docker-compose-node1.yml</p>
<pre><code class="language-yml">version: '3'
networks:
  main:

  services:
    node1:
    container_name: node1
    image: cita/cita-release:20.2.0-sm2-sm3
    hostname: node1
    networks:
      main:
        aliases:
          - node1
    volumes:
      - ./:/opt/cita-run
    ports:
      - &quot;1337:1337&quot;
    command: |
      bash -c '
      while [[ ! -d /opt/cita-run/test-chain ]]; do sleep 1; done;
      sleep 10;
      cita setup test-chain/1;
      cita start test-chain/1;
      sleep infinity'
</code></pre>
<p>node-2节点文件<br>
docker-compose-node2.yml<br>
...</p>
<h3 id="3-启动服务">3. 启动服务</h3>
<p><code>docker-compose-node0.yml</code><br>
<code>docker-compose-node1.yml</code><br>
<code>docker-compose-node2.yml</code></p>
<h3 id="验证-cita-是否运行正常">验证 CITA 是否运行正常</h3>
<p>进入容器执行命令检查服务状态</p>
<pre><code class="language-bash">docker exec -it node0 bash
root@node0:/opt/cita-run# cita top test-chain/0
root       2042      1  0 Aug25 ?        00:00:00 cita-forever
root       2051   2042  0 Aug25 ?        00:05:51 cita-auth -c auth.toml
root       2069   2042  0 Aug25 ?        00:02:10 cita-bft -c consensus.toml -p privkey
root       2061   2042  0 Aug25 ?        00:00:24 cita-chain -c chain.toml
root       2054   2042  0 Aug25 ?        00:01:50 cita-executor -c executor.toml
root       2062   2042  0 Aug25 ?        00:00:55 cita-jsonrpc -c jsonrpc.toml
root       2053   2042  0 Aug25 ?        00:05:40 cita-network -c network.toml

</code></pre>
<p>检查 7 个服务是否都已经启动。<br>
分别去其他节点依次检查</p>
<p>检查日志有无报错情况<br>
cita-network.log日志会有<br>
<code>ERROR - [NodeManager] Can not get node status from known_addr, this should ·not happen!</code><br>
忽略即可</p>
<h2 id="基本命">基本命</h2>
<h3 id="查看块高度">查看块高度</h3>
<pre><code class="language-bash">cita-cli rpc blockNumber

{
  &quot;id&quot;: 1,
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: &quot;0x13678&quot;
}

其中 result 表示本次查询时的块高度为 0x13678。 CITA 默认 3s 出一个块，重复执行查询命令，可以观察到 result 在持续的增长。
</code></pre>
<h3 id="部署合约">部署合约</h3>
<p>执行命令</p>
<pre><code class="language-bash">cita-cli rpc sendRawTransaction \
    --code 0x608060405234801561001057600080fd5b5060df8061001f6000396000f3006080604052600436106049576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806360fe47b114604e5780636d4ce63c146078575b600080fd5b348015605957600080fd5b5060766004803603810190808035906020019092919050505060a0565b005b348015608357600080fd5b50608a60aa565b6040518082815260200191505060405180910390f35b8060008190555050565b600080549050905600a165627a7a723058205aed214856a5c433292a354261c9eb88eed1396c83dabbe105bde142e49838ac0029 \
    --private-key 0x3ef2627393529fed043c7dbfd9358a4ae47a88a59949b07e7631722fd6959002
    --url  http://127.0.0.1:1337   --algorithm sm2
</code></pre>
<p>该命令将合约的字节码部署到区块链上。</p>
<p>命令返回：</p>
<pre><code class="language-bash">{
  &quot;id&quot;: 4,
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;hash&quot;: &quot;0x36e7c55e48df9e465200c55cad1cb14fe677edc8ea087b97c9b8c1ed9495670e&quot;,
    &quot;status&quot;: &quot;OK&quot;
  }
}
</code></pre>
<h3 id="查看回执">查看回执</h3>
<p>执行命令：</p>
<pre><code class="language-bash">cita-cli rpc getTransactionReceipt --hash 0x36e7c55e48df9e465200c55cad1cb14fe677edc8ea087b97c9b8c1ed9495670e
</code></pre>
<p>其中的 hash 为部署合约的交易 hash，所查询的结果为部署合约的交易回执。<br>
命令返回：</p>
<pre><code class="language-bash">{
  &quot;id&quot;: 1,
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;blockHash&quot;: &quot;0xb9e2167e07550c55406acc22f8d3d83fa81cfd29430c9b5ffb5a7e58fbf130c0&quot;,
    &quot;blockNumber&quot;: &quot;0x136b3&quot;,
    &quot;contractAddress&quot;: &quot;0xb701924639d802dc8093d1a43dffa9939a4506de&quot;,
    &quot;cumulativeQuotaUsed&quot;: &quot;0x17d9d&quot;,
    &quot;errorMessage&quot;: null,
    &quot;logs&quot;: [
    ],
    &quot;logsBloom&quot;: &quot;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;,
    &quot;quotaUsed&quot;: &quot;0x17d9d&quot;,
    &quot;root&quot;: null,
    &quot;transactionHash&quot;: &quot;0x36e7c55e48df9e465200c55cad1cb14fe677edc8ea087b97c9b8c1ed9495670e&quot;,
    &quot;transactionIndex&quot;: &quot;0x0&quot;
  }
}
</code></pre>
<h3 id="查看交易">查看交易</h3>
<p>执行命令：</p>
<pre><code class="language-bash">cita-cli rpc getTransaction --hash  0x36e7c55e48df9e465200c55cad1cb14fe677edc8ea087b97c9b8c1ed9495670e
</code></pre>
<p>其中的 hash 为部署合约的交易 hash，所查询的结果为部署合约的交易信息。<br>
命令返回：</p>
<pre><code class="language-bash">{
  &quot;id&quot;: 1,
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;blockHash&quot;: &quot;0xb9e2167e07550c55406acc22f8d3d83fa81cfd29430c9b5ffb5a7e58fbf130c0&quot;,
    &quot;blockNumber&quot;: &quot;0x136b3&quot;,
    &quot;content&quot;: &quot;0x0af202122032343532366161336362383834626164626166656261313437623932663939661880ade2042089ee042afe01608060405234801561001057600080fd5b5060df8061001f6000396000f3006080604052600436106049576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806360fe47b114604e5780636d4ce63c146078575b600080fd5b348015605957600080fd5b5060766004803603810190808035906020019092919050505060a0565b005b348015608357600080fd5b50608a60aa565b6040518082815260200191505060405180910390f35b8060008190555050565b600080549050905600a165627a7a723058205aed214856a5c433292a354261c9eb88eed1396c83dabbe105bde142e49838ac00293220000000000000000000000000000000000000000000000000000000000000000040025220000000000000000000000000000000000000000000000000000000000000000112413fd75865ad692e8903d05c4cadcca4b52621c5b6a4798c9300c2927f6c1b915210d5be6956d0cac8dea79b6a9ac0f1de09dee275eeb4bf871e08ad5a920f8fbb01&quot;,
    &quot;from&quot;: &quot;0x37d1c7449bfe76fe9c445e626da06265e9377601&quot;,
    &quot;hash&quot;: &quot;0x36e7c55e48df9e465200c55cad1cb14fe677edc8ea087b97c9b8c1ed9495670e&quot;,
    &quot;index&quot;: &quot;0x0&quot;
  }
}
</code></pre>
<p>其中 content 为交易数据。由于数据经过了签名处理，所以与部署合约时指定的 --code 不一致。可以使用 cita-cli 提供的 decode-unverifiedTransaction 命令来解码。</p>
<p>执行命令：</p>
<pre><code class="language-bash">cita-cli tx decode-unverifiedTransaction --content   0x0af202122032343532366161336362383834626164626166656261313437623932663939661880ade2042089ee042afe01608060405234801561001057600080fd5b5060df8061001f6000396000f3006080604052600436106049576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806360fe47b114604e5780636d4ce63c146078575b600080fd5b348015605957600080fd5b5060766004803603810190808035906020019092919050505060a0565b005b348015608357600080fd5b50608a60aa565b6040518082815260200191505060405180910390f35b8060008190555050565b600080549050905600a165627a7a723058205aed214856a5c433292a354261c9eb88eed1396c83dabbe105bde142e49838ac00293220000000000000000000000000000000000000000000000000000000000000000040025220000000000000000000000000000000000000000000000000000000000000000112413fd75865ad692e8903d05c4cadcca4b52621c5b6a4798c9300c2927f6c1b915210d5be6956d0cac8dea79b6a9ac0f1de09dee275eeb4bf871e08ad5a920f8fbb01
</code></pre>
<p>命令返回：</p>
<pre><code class="language-bash">{
  &quot;crypto&quot;: 0,
  &quot;signature&quot;: &quot;0x3fd75865ad692e8903d05c4cadcca4b52621c5b6a4798c9300c2927f6c1b915210d5be6956d0cac8dea79b6a9ac0f1de09dee275eeb4bf871e08ad5a920f8fbb01&quot;,
  &quot;transaction&quot;: {
    &quot;chain_id&quot;: 0,
    &quot;chain_id_v1&quot;: &quot;0x0000000000000000000000000000000000000000000000000000000000000001&quot;,
    &quot;data&quot;: &quot;0x608060405234801561001057600080fd5b5060df8061001f6000396000f3006080604052600436106049576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806360fe47b114604e5780636d4ce63c146078575b600080fd5b348015605957600080fd5b5060766004803603810190808035906020019092919050505060a0565b005b348015608357600080fd5b50608a60aa565b6040518082815260200191505060405180910390f35b8060008190555050565b600080549050905600a165627a7a723058205aed214856a5c433292a354261c9eb88eed1396c83dabbe105bde142e49838ac0029&quot;,
    &quot;encrypted_hash&quot;: &quot;0x8d434bd11a8f94f6fb128b1b941daa573daa21d795858f366fed1593f6eb30ff&quot;,
    &quot;nonce&quot;: &quot;24526aa3cb884badbafeba147b92f99f&quot;,
    &quot;pub_key&quot;: &quot;0x9dc6fc7856f5271e6e8c45e5c5fe22d2ff699ac3b24497599be77803d3c25fb4e2fe7da616c65a291910c947c89923009f354634421bddd0a25cd0a509bcf6a9&quot;,
    &quot;quota&quot;: 10000000,
    &quot;sender&quot;: &quot;0x37d1c7449bfe76fe9c445e626da06265e9377601&quot;,
    &quot;to&quot;: &quot;&quot;,
    &quot;to_v1&quot;: &quot;0x0000000000000000000000000000000000000000&quot;,
    &quot;valid_until_block&quot;: 79625,
    &quot;value&quot;: &quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,
    &quot;version&quot;: 2
  }
}
</code></pre>
<p>其中的 data 数据便与部署合约中指定的 code 相一致。</p>
<h3 id="调用合约">调用合约</h3>
<p>执行命令，调用 set 函数：</p>
<pre><code class="language-bash">cita-cli rpc sendRawTransaction \
    --code 0x60fe47b10000000000000000000000000000000000000000000000000000000000000001 \
    --private-key 0x3ef2627393529fed043c7dbfd9358a4ae47a88a59949b07e7631722fd6959002 \
    --address 0xb701924639d802dc8093d1a43dffa9939a4506de
</code></pre>
<p>注意：这里的 address 要与部署合约回执中的 contractAddress 相一致。</p>
<p>命令返回：</p>
<pre><code class="language-bash">{
  &quot;id&quot;: 4,
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;hash&quot;: &quot;0xd68853e6df7893b5b2299abaf8cb2631e37b4047dbab55511c96c459efd2242b&quot;,
    &quot;status&quot;: &quot;OK&quot;
  }
}
</code></pre>
<h2 id="修改个别配置操作示例">修改个别配置操作示例</h2>
<p>起链后，也就是说创世块一旦生成，除 chainName、operator、website 三项可以在运行时更改，其他配置均无法修改。接下来我们用 cita-cli 来进行演示，以超级管理员修改 chainName 作为示例：</p>
<p>确保你的链正常运行，进入 cita-cli 交互式模式，输入命令：</p>
<pre><code class="language-bash">$ scm SysConfig setChainName --chain-name &quot;AAA&quot; --admin-private \ 0x5f0258a4778057a8a7d97809bd209055b2fbafa654ce7d31ec7191066b9225e6
</code></pre>
<p>查询交易回执无误后，我们成功的把链名称从默认的 test-chain 更改为 AAA。</p>
<p>我们可以通过 getMeta 查询更改后的结果，示例如下：</p>
<p><code>rpc getMetaData</code></p>
<p>输出：</p>
<pre><code class="language-bash">{
  &quot;id&quot;: 1,
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;blockInterval&quot;: 3000,
    &quot;chainId&quot;: 1,
    &quot;chainName&quot;: &quot;AAA&quot;,
    &quot;economicalModel&quot;: 1,
    &quot;genesisTimestamp&quot;: 1538101178583,
    &quot;operator&quot;: &quot;test-operator&quot;,
    &quot;tokenAvatar&quot;: &quot;https://cdn.citahub.com/icon_cita.png&quot;,
    &quot;tokenName&quot;: &quot;CITA Test Token&quot;,
    &quot;tokenSymbol&quot;: &quot;CTT&quot;,
    &quot;validators&quot;: [
      &quot;0x185e7072f53574666cf8ed8ec080e09b7e39c98f&quot;
    ],
    &quot;version&quot;: 1,
    &quot;website&quot;: &quot;https://www.example.com&quot;
  }
}
</code></pre>
<h2 id="节点管理">节点管理</h2>
<h3 id="节点分类">节点分类</h3>
<p>CITA区块链分为两大类节点：</p>
<ul>
<li>共识节点：共识节点具有出块和投票权限，交易由共识节点排序并打包成块，共识完成后即被确认为合法区块。</li>
<li>普通节点：普通节点没有出块和投票权限，其他方面和共识节点相同。可以同步和验证链上所有的原始数据，接受交易数据并向其他节点广播。</li>
</ul>
<p>###普通节点管理<br>
普通节点的管理，是指普通节点的添加与删除。当前 CITA 的节点发现提供两种机制：</p>
<ul>
<li>自动发现机制，本节点会自动通过所配置的 peers 发现网络中的其它节点并尝试连接。</li>
<li>配置文件发现机制，本节点仅连接 peers 中所配置的节点。</li>
</ul>
<p>CITA 的节点发现机制通过 network 网络配置 中的 enable_discovery 配置项设置。</p>
<p><strong>添加普通节点（以下以 4 号节点举例）</strong></p>
<ol>
<li>假设目前的工作目录在 cita/target/install/ 下：</li>
</ol>
<pre><code class="language-bash">$ ls test-chain/
  0  1  2  3  template
</code></pre>
<p>template 中保存了当前节点的公钥地址 template/authorities.list，以及创世块信息 template/configs/genesis.json，目前地址有四个。</p>
<ol start="2">
<li>生成新 node：</li>
</ol>
<pre><code class="language-bash">$ ./bin/cita append --chain_name test-chain --node &quot;127.0.0.1:4004&quot;
$ ls test-chain/
  0  1  2  3  4  template
</code></pre>
<ul>
<li>append 子命令，在指定链中增加对应 ip 地址的节点。</li>
<li>脚本将自动生成 4 号节点，并在原有节点中 test-chain/*/network.toml 中插入新节点的 ip 及端口配置。</li>
</ul>
<blockquote>
<p>注： 如果不同机器的节点就要手动去修改 network.toml 文件了</p>
</blockquote>
<ol start="3">
<li>启动新节点：</li>
</ol>
<p>新节点只需要按照正常流程启动，就可以连接入网络，并开始同步链上的块数据。</p>
<blockquote>
<p>注意：<br>
a. 此时的新节点为普通节点，不参与共识选举，即只能同步数据和接收 jsonrpc 请求。<br>
b. 当 network 网络配置为 enable_discovery = false 时，需要在原来节点的 network.toml 文件中 peers 域添加新节点信息。</p>
</blockquote>
<pre><code class="language-bash">$ ./bin/cita setup test-chain/4
$ ./bin/cita start test-chain/4
</code></pre>
<p><strong>删除普通节点</strong></p>
<ul>
<li>当 network 网络配置为 enable_discovery = false 时，到对应节点目录下，找到 network.toml，删除对应 peers 条目即可。</li>
<li>当 network 网络配置为 enable_discovery = true 时，一个节点主动下线，该节点便在网络中被移除。</li>
</ul>
<h3 id="共识节点管理">共识节点管理</h3>
<p>增加共识节点<br>
节点需先被添加成为普通节点（参考普通节点管理），才能申请成为共识节点，由超级管理员（拥有超级管理员角色的账号）确认才完成了添加操作。</p>
<p>从普通节点升级到共识节点，具体操作需要用到上面合约方法 approveNode(address)。</p>
<p>共识节点管理合约是系统合约，默认将放在创世块上，下面使用 solc 命令（solidity 的命令行编译器，在 CITA 镜像中已安装）查看共识节点管理合约的 hash：</p>
<pre><code class="language-bash">$ solc --hashes system/node_manager.sol --allow-paths .
contract address: 0xffffffffffffffffffffffffffffffffff020001
Function signatures:
    dd4c97a0: approveNode(address)
    2d4ede93: deleteNode(address)
    30ccebb5: getStatus(address)
    609df32f: listNode()
    6ed3876d: listStake()
    51222d50: setStake(address,uint64)
    0c829315: stakePermillage(address)
    645b8b1b: status(address)
</code></pre>
<p>首先需要启动一条链，具体方法见快速入门部分</p>
<p>接下来的测试，用 cita-cli 命令行模式（与交互式模式的命令是一致的）进行演示。</p>
<h4 id="查看当前的共识节点列表">查看当前的共识节点列表：</h4>
<p><code>cita-cli scm NodeManager listNode --url http://127.0.0.1:1337</code></p>
<p>输出:</p>
<pre><code class="language-bash">{
  &quot;id&quot;: 1,
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: &quot;0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000004dd0951bd05d394324279cbcb2b40b4398938f56000000000000000000000000a222f39026a7423592de6fe00383de27facdd51a&quot;
}
</code></pre>
<p>返回值为目前的共识节点地址列表。</p>
<p>下面我们需要将新增的普通节点通过交易的方式升级为共识节点，新增的普通节点的公钥地址，演示中，为 0xa800dab858271557b1e6e9e62eb8b2f22560da4b</p>
<ul>
<li>发送交易</li>
</ul>
<pre><code class="language-bash">$ cita-cli scm NodeManager approveNode \
    --address 0xa800dab858271557b1e6e9e62eb8b2f22560da4b \
    --admin-private 0x7664a098547142fdf7fc3a732607f707512f98df4d6b7040f009858813e257d5 \
    --url http://127.0.0.1:1337    --algorithm sm2
</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://chriswsq.github.io/tag/vUYHfbEAx/" class="tag">
                    cita
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://chriswsq.github.io/post/kubernetes-ji-chu-jiao-xue-san-helm-jie-shao-yu-jian-li-chart/">
                  <h3 class="post-title">
                    Kubernetes 基礎教學（三）Helm 介紹與建立 Chart
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>





  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: '',
        owner: '',
        admin: [''],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
