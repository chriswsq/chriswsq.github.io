<html>
      <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <meta name="referrer" content="never">
        <title>docker部署Prometheus监控服务器及容器并发送告警 | chris&#39;wang</title>
        <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
        <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://chriswsq.github.io/styles/main.css">
          <script src="https://chriswsq.github.io/media/scripts/mdui.min.js"></script>
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://fonts.googleapis.com/css?family=Dancing+Script|Ma+Shan+Zheng&display=swap" rel="stylesheet">
        <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
        <script src="https://chriswsq.github.io/media/scripts/script.js"></script>
        <script >hljs.initHighlightingOnLoad();</script>
        

    </head>
    <body class="mdui-theme-primary-purple mdui-theme-accent-purple">
        <header class="index-img mdui-m-b-3" >
                          <button class="mdui-btn  mdui-btn-icon mdui-btn-dense mdui-color-theme-500 mdui-ripple yinying mdui-m-t-1 mdui-m-l-1" mdui-menu="{target: '#demo-attr-cascade'}"><i class="mdui-icon material-icons">&#xe5d2;</i></button>
                <ul class="mdui-menu" id="demo-attr-cascade">
                
                        <li class="mdui-menu-item">
                          <a href="/" class="mdui-ripple">首页</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/archives" class="mdui-ripple">归档</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/tags" class="mdui-ripple">标签</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/post/about" class="mdui-ripple">关于</a>
                        </li>
                
                      </ul>

        </header>
        <div class="mdui-container post">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                         <article class="mdui-shadow-10 mdui-p-a-2 post-list">
                           <div class="mdui-typo-display-1 mdui-m-b-3">docker部署Prometheus监控服务器及容器并发送告警</div>
                           <a  class="index-list-biaoqian ">2020-09-03</a>
                           <div class="mdui-typo mdui-m-t-3 post-neirong"><p>记录一下利用prometheus监控服务器信息和容器服务并发送邮件告警</p>
<!-- more -->
<h2 id="基本原理">基本原理</h2>
<p>Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。</p>
<h2 id="相关组件">相关组件</h2>
<ul>
<li>Prometheus: Prometheus Daemon负责定时去目标上抓取metrics(指标)数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。</li>
<li>Grafana: 接入prometheus数据，图形化展示监控信息</li>
<li>Node-exporter: 负责收集 host 硬件和操作系统数据。它将以容器方式运行在所有 host 上。</li>
<li>Cadvisor: 负责收集容器数据。它将以容器方式运行在所有 host 上。</li>
<li>Alertmanager: 警告管理器，用来进行报警。</li>
</ul>
<table>
<thead>
<tr>
<th>主机名</th>
<th>ip</th>
<th>服务</th>
</tr>
</thead>
<tbody>
<tr>
<td>test-1</td>
<td>192.168.40.6</td>
<td>cadvisor、node-exporter、grafana、prometheus、alertmanager.yml</td>
</tr>
<tr>
<td>test-2</td>
<td>192.168.40.7</td>
<td>node-exporter、cadvisor</td>
</tr>
<tr>
<td>test-3</td>
<td>192.168.40.8</td>
<td>node-exporter、cadvisor</td>
</tr>
</tbody>
</table>
<h2 id="安装docker-docker-compose">安装docker、docker-compose</h2>
<h3 id="安装docker">安装docker</h3>
<pre><code class="language-bash"># 安装依赖包
yum install -y yum-utils device-mapper-persistent-data lvm2
# 添加Docker软件包源
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
# 安装Docker CE
yum install docker-ce -y
# 启动
systemctl start docker
# 开机启动
systemctl enable docker
# 查看Docker信息
docker info
</code></pre>
<h3 id="安装docker-compose">安装docker-compose</h3>
<pre><code class="language-bash">curl -L https://github.com/docker/compose/releases/download/1.23.2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
</code></pre>
<h2 id="添加配置文件">添加配置文件</h2>
<pre><code class="language-bash">mkdir -p /usr/local/src/config
cd /usr/local/src/config
</code></pre>
<h3 id="添加prometheusyml配置文件">添加prometheus.yml配置文件</h3>
<p>vim prometheus.yml</p>
<pre><code class="language-bash"># my global config
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
  - static_configs:
    - targets:
       - 192.168.40.6:9093

rule_files:
  - &quot;/etc/prometheus/config/rule/*rule.yml&quot;

scrape_configs:
  - job_name: 'prometheus'
    scrape_interval: 5s
    static_configs:
        - targets: ['192.168.40.6:9090']

  - job_name: 'cadvisor'
    scrape_interval: 5s
    static_configs:
        - targets: ['192.168.40.6:8080', '192.168.40.7:8080', '192.168.40.8']

  - job_name: 'node-exporter'
    scrape_interval: 5s
    static_configs:
        - targets: ['192.168.40.6:9100']
          labels:
            instance: test-1 - 192.168.40.6
            service: node-service
        - targets: ['192.168.40.7:9100']
          labels:
            instance: test-2 - 192.168.40.7
            service: node-service
        - targets: ['192.168.40.8:9100']
          labels:
            instance: test-3 - 192.168.40.8
            service: node-service
</code></pre>
<h3 id="添加邮件告警配置文件">添加邮件告警配置文件</h3>
<p>添加配置文件alertmanager.yml，配置收发邮件邮箱<br>
vim alertmanager.yml</p>
<pre><code class="language-bash">global:
  # The smarthost and SMTP sender used for mail notifications.  用于邮件通知的智能主机和SMTP发件人。
  smtp_smarthost: 'smtp.163.com:25'
  smtp_from: 'xxxxxxxxx@163.com'
  smtp_auth_username: 'xxxxxxxxxxxxxxx@163.com'
  smtp_auth_password: 'xxxxxxxxxxxxx'
  # The auth token for Hipchat.    Hipchat的身份验证令牌。

templates:
  - '/etc/alertmanager/default-monitor.tmpl'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 5m
  receiver: 'mail'


receivers:
- name: 'mail'
  email_configs:
  - to: 'xxxxxxxxxxxxxxxx@163.com, xxxxxxxxxxxxxx@qq.com'
    send_resolved: true #告警恢复通知
    html: '{{ template &quot;default-monitor.html&quot; . }}'  #应用那个模板
    headers: { Subject: &quot;[WARN] 报警邮件&quot; } #邮件主题信息 如果不写headers也可以在模板中定义默认加载email.default.subject这个模板
</code></pre>
<h3 id="添加报警规则">添加报警规则</h3>
<pre><code class="language-bash">mkdir -p /usr/local/src/config/rule
cd /usr/local/src/config/rule
</code></pre>
<p>创建两个文件</p>
<p>node-exporter-record-rule.yml<br>
node-exporter-alert-rule.yml</p>
<p>第一个文件用于记录规则，第二个是报警规则。<br>
由于之前我们在prometheus.yml中已经引用了所有已rule结尾的文件，所以我们不用在修改prometheus.yml配置文件。</p>
<p>创建node-exporter-record-rule.yml</p>
<pre><code class="language-bash">groups:
  - name: node-exporter-record
    rules:
    - expr: up{job=~&quot;node-exporter&quot;}
      record: node_exporter:up
      labels:
        desc: &quot;节点是否在线, 在线1,不在线0&quot;
        unit: &quot; &quot;
        job: &quot;node-exporter&quot;
    - expr: time() - node_boot_time_seconds{}
      record: node_exporter:node_uptime
      labels:
        desc: &quot;节点的运行时间&quot;
        unit: &quot;s&quot;
        job: &quot;node-exporter&quot;
##############################################################################################
#                              cpu                                                           #
    - expr: (1 - avg by (environment,instance) (irate(node_cpu_seconds_total{job=&quot;node-exporter&quot;,mode=&quot;idle&quot;}[5m])))  * 100
      record: node_exporter:cpu:total:percent
      labels:
        desc: &quot;节点的cpu总消耗百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total{job=&quot;node-exporter&quot;,mode=&quot;idle&quot;}[5m])))  * 100
      record: node_exporter:cpu:idle:percent
      labels:
        desc: &quot;节点的cpu idle百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total{job=&quot;node-exporter&quot;,mode=&quot;iowait&quot;}[5m])))  * 100
      record: node_exporter:cpu:iowait:percent
      labels:
        desc: &quot;节点的cpu iowait百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;


    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total{job=&quot;node-exporter&quot;,mode=&quot;system&quot;}[5m])))  * 100
      record: node_exporter:cpu:system:percent
      labels:
        desc: &quot;节点的cpu system百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total{job=&quot;node-exporter&quot;,mode=&quot;user&quot;}[5m])))  * 100
      record: node_exporter:cpu:user:percent
      labels:
        desc: &quot;节点的cpu user百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total{job=&quot;node-exporter&quot;,mode=~&quot;softirq|nice|irq|steal&quot;}[5m])))  * 100
      record: node_exporter:cpu:other:percent
      labels:
        desc: &quot;节点的cpu 其他的百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;
##############################################################################################


##############################################################################################
#                                    memory                                                  #
    - expr: node_memory_MemTotal_bytes{job=&quot;node-exporter&quot;}
      record: node_exporter:memory:total
      labels:
        desc: &quot;节点的内存总量&quot;
        unit: byte
        job: &quot;node-exporter&quot;

    - expr: node_memory_MemFree_bytes{job=&quot;node-exporter&quot;}
      record: node_exporter:memory:free
      labels:
        desc: &quot;节点的剩余内存量&quot;
        unit: byte
        job: &quot;node-exporter&quot;

    - expr: node_memory_MemTotal_bytes{job=&quot;node-exporter&quot;} - node_memory_MemFree_bytes{job=&quot;node-exporter&quot;}
      record: node_exporter:memory:used
      labels:
        desc: &quot;节点的已使用内存量&quot;
        unit: byte
        job: &quot;node-exporter&quot;

    - expr: node_memory_MemTotal_bytes{job=&quot;node-exporter&quot;} - node_memory_MemAvailable_bytes{job=&quot;node-exporter&quot;}
      record: node_exporter:memory:actualused
      labels:
        desc: &quot;节点用户实际使用的内存量&quot;
        unit: byte
        job: &quot;node-exporter&quot;

    - expr: (1-(node_memory_MemAvailable_bytes{job=&quot;node-exporter&quot;} / (node_memory_MemTotal_bytes{job=&quot;node-exporter&quot;})))* 100
      record: node_exporter:memory:used:percent
      labels:
        desc: &quot;节点的内存使用百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

    - expr: ((node_memory_MemAvailable_bytes{job=&quot;node-exporter&quot;} / (node_memory_MemTotal_bytes{job=&quot;node-exporter&quot;})))* 100
      record: node_exporter:memory:free:percent
      labels:
        desc: &quot;节点的内存剩余百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;
##############################################################################################
#                                   load                                                     #
    - expr: sum by (instance) (node_load1{job=&quot;node-exporter&quot;})
      record: node_exporter:load:load1
      labels:
        desc: &quot;系统1分钟负载&quot;
        unit: &quot; &quot;
        job: &quot;node-exporter&quot;

    - expr: sum by (instance) (node_load5{job=&quot;node-exporter&quot;})
      record: node_exporter:load:load5
      labels:
        desc: &quot;系统5分钟负载&quot;
        unit: &quot; &quot;
        job: &quot;node-exporter&quot;

    - expr: sum by (instance) (node_load15{job=&quot;node-exporter&quot;})
      record: node_exporter:load:load15
      labels:
        desc: &quot;系统15分钟负载&quot;
        unit: &quot; &quot;
        job: &quot;node-exporter&quot;

##############################################################################################
#                                 disk                                                       #
    - expr: node_filesystem_size_bytes{job=&quot;node-exporter&quot; ,fstype=~&quot;ext4|xfs&quot;}
      record: node_exporter:disk:usage:total
      labels:
        desc: &quot;节点的磁盘总量&quot;
        unit: byte
        job: &quot;node-exporter&quot;

    - expr: node_filesystem_avail_bytes{job=&quot;node-exporter&quot;,fstype=~&quot;ext4|xfs&quot;}
      record: node_exporter:disk:usage:free
      labels:
        desc: &quot;节点的磁盘剩余空间&quot;
        unit: byte
        job: &quot;node-exporter&quot;

    - expr: node_filesystem_size_bytes{job=&quot;node-exporter&quot;,fstype=~&quot;ext4|xfs&quot;} - node_filesystem_avail_bytes{job=&quot;node-exporter&quot;,fstype=~&quot;ext4|xfs&quot;}
      record: node_exporter:disk:usage:used
      labels:
        desc: &quot;节点的磁盘使用的空间&quot;
        unit: byte
        job: &quot;node-exporter&quot;

    - expr:  (1 - node_filesystem_avail_bytes{job=&quot;node-exporter&quot;,fstype=~&quot;ext4|xfs&quot;} / node_filesystem_size_bytes{job=&quot;node-exporter&quot;,fstype=~&quot;ext4|xfs&quot;}) * 100
      record: node_exporter:disk:used:percent
      labels:
        desc: &quot;节点的磁盘的使用百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

    - expr: irate(node_disk_reads_completed_total{job=&quot;node-exporter&quot;}[1m])
      record: node_exporter:disk:read:count:rate
      labels:
        desc: &quot;节点的磁盘读取速率&quot;
        unit: &quot;次/秒&quot;
        job: &quot;node-exporter&quot;

    - expr: irate(node_disk_writes_completed_total{job=&quot;node-exporter&quot;}[1m])
      record: node_exporter:disk:write:count:rate
      labels:
        desc: &quot;节点的磁盘写入速率&quot;
        unit: &quot;次/秒&quot;
        job: &quot;node-exporter&quot;

    - expr: (irate(node_disk_written_bytes_total{job=&quot;node-exporter&quot;}[1m]))/1024/1024
      record: node_exporter:disk:read:mb:rate
      labels:
        desc: &quot;节点的设备读取MB速率&quot;
        unit: &quot;MB/s&quot;
        job: &quot;node-exporter&quot;

    - expr: (irate(node_disk_read_bytes_total{job=&quot;node-exporter&quot;}[1m]))/1024/1024
      record: node_exporter:disk:write:mb:rate
      labels:
        desc: &quot;节点的设备写入MB速率&quot;
        unit: &quot;MB/s&quot;
        job: &quot;node-exporter&quot;

##############################################################################################
#                                filesystem                                                  #
    - expr:   (1 -node_filesystem_files_free{job=&quot;node-exporter&quot;,fstype=~&quot;ext4|xfs&quot;} / node_filesystem_files{job=&quot;node-exporter&quot;,fstype=~&quot;ext4|xfs&quot;}) * 100
      record: node_exporter:filesystem:used:percent
      labels:
        desc: &quot;节点的inode的剩余可用的百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;
#############################################################################################
#                                filefd                                                     #
    - expr: node_filefd_allocated{job=&quot;node-exporter&quot;}
      record: node_exporter:filefd_allocated:count
      labels:
        desc: &quot;节点的文件描述符打开个数&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

    - expr: node_filefd_allocated{job=&quot;node-exporter&quot;}/node_filefd_maximum{job=&quot;node-exporter&quot;} * 100
      record: node_exporter:filefd_allocated:percent
      labels:
        desc: &quot;节点的文件描述符打开百分比&quot;
        unit: &quot;%&quot;
        job: &quot;node-exporter&quot;

#############################################################################################
#                                network                                                    #
    - expr: avg by (environment,instance,device) (irate(node_network_receive_bytes_total{device=~&quot;eth0|eth1|ens33|ens37&quot;}[1m]))
      record: node_exporter:network:netin:bit:rate
      labels:
        desc: &quot;节点网卡eth0每秒接收的比特数&quot;
        unit: &quot;bit/s&quot;
        job: &quot;node-exporter&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_transmit_bytes_total{device=~&quot;eth0|eth1|ens33|ens37&quot;}[1m]))
      record: node_exporter:network:netout:bit:rate
      labels:
        desc: &quot;节点网卡eth0每秒发送的比特数&quot;
        unit: &quot;bit/s&quot;
        job: &quot;node-exporter&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_receive_packets_total{device=~&quot;eth0|eth1|ens33|ens37&quot;}[1m]))
      record: node_exporter:network:netin:packet:rate
      labels:
        desc: &quot;节点网卡每秒接收的数据包个数&quot;
        unit: &quot;个/秒&quot;
        job: &quot;node-exporter&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_transmit_packets_total{device=~&quot;eth0|eth1|ens33|ens37&quot;}[1m]))
      record: node_exporter:network:netout:packet:rate
      labels:
        desc: &quot;节点网卡发送的数据包个数&quot;
        unit: &quot;个/秒&quot;
        job: &quot;node-exporter&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_receive_errs_total{device=~&quot;eth0|eth1|ens33|ens37&quot;}[1m]))
      record: node_exporter:network:netin:error:rate
      labels:
        desc: &quot;节点设备驱动器检测到的接收错误包的数量&quot;
        unit: &quot;个/秒&quot;
        job: &quot;node-exporter&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_transmit_errs_total{device=~&quot;eth0|eth1|ens33|ens37&quot;}[1m]))
      record: node_exporter:network:netout:error:rate
      labels:
        desc: &quot;节点设备驱动器检测到的发送错误包的数量&quot;
        unit: &quot;个/秒&quot;
        job: &quot;node-exporter&quot;

    - expr: node_tcp_connection_states{job=&quot;node-exporter&quot;, state=&quot;established&quot;}
      record: node_exporter:network:tcp:established:count
      labels:
        desc: &quot;节点当前established的个数&quot;
        unit: &quot;个&quot;
        job: &quot;node-exporter&quot;

    - expr: node_tcp_connection_states{job=&quot;node-exporter&quot;, state=&quot;time_wait&quot;}
      record: node_exporter:network:tcp:timewait:count
      labels:
        desc: &quot;节点timewait的连接数&quot;
        unit: &quot;个&quot;
        job: &quot;node-exporter&quot;

    - expr: sum by (environment,instance) (node_tcp_connection_states{job=&quot;node-exporter&quot;})
      record: node_exporter:network:tcp:total:count
      labels:
        desc: &quot;节点tcp连接总数&quot;
        unit: &quot;个&quot;
        job: &quot;node-exporter&quot;

#############################################################################################
#                                process                                                    #
    - expr: node_processes_state{state=&quot;Z&quot;}
      record: node_exporter:process:zoom:total:count
      labels:
        desc: &quot;节点当前状态为zoom的个数&quot;
        unit: &quot;个&quot;
        job: &quot;node-exporter&quot;
#############################################################################################
#                                other                                                    #
    - expr: abs(node_timex_offset_seconds{job=&quot;node-exporter&quot;})
      record: node_exporter:time:offset
      labels:
        desc: &quot;节点的时间偏差&quot;
        unit: &quot;s&quot;
        job: &quot;node-exporter&quot;

#############################################################################################

    - expr: count by (instance) ( count by (instance,cpu) (node_cpu_seconds_total{ mode='system'}) )
      record: node_exporter:cpu:count
</code></pre>
<p>创建node-exporter-alert-rule.yml</p>
<pre><code class="language-bash">groups:
  - name: node-exporter-alert
    rules:
    - alert: node-exporter-down
      expr: node_exporter:up == 0
      for: 1m
      labels:
        severity: 'critical'
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 宕机了&quot;
        description: &quot;instance: {{ $labels.instance }} \n- job: {{ $labels.job }} 关机了， 时间已经1分钟了。&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;



    - alert: node-exporter-cpu-high
      expr:  node_exporter:cpu:total:percent &gt; 80
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} cpu 使用率高于 {{ $value }}&quot;
        description: &quot;instance: {{ $labels.instance }} \n- job: {{ $labels.job }} CPU使用率已经持续三分钟高过80% 。&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;

    - alert: node-exporter-cpu-iowait-high
      expr:  node_exporter:cpu:iowait:percent &gt;= 12
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} cpu iowait 使用率高于 {{ $value }}&quot;
        description: &quot;instance: {{ $labels.instance }} \n- job: {{ $labels.job }} cpu iowait使用率已经持续三分钟高过12%&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-load-load1-high
      expr:  (node_exporter:load:load1) &gt; (node_exporter:cpu:count) * 1.2
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} load1 使用率高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-memory-high
      expr:  node_exporter:memory:used:percent &gt; 85
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} memory 使用率高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-disk-high
      expr:  node_exporter:disk:used:percent &gt; 88
      for: 10m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} disk 使用率高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-disk-read:count-high
      expr:  node_exporter:disk:read:count:rate &gt; 3000
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} iops read 使用率高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-disk-write-count-high
      expr:  node_exporter:disk:write:count:rate &gt; 3000
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} iops write 使用率高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;





    - alert: node-exporter-disk-read-mb-high
      expr:  node_exporter:disk:read:mb:rate &gt; 60
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 读取字节数 高于 {{ $value }}&quot;
        description: &quot;&quot;
        instance: &quot;{{ $labels.instance }}&quot;
        value: &quot;{{ $value }}&quot;


    - alert: node-exporter-disk-write-mb-high
      expr:  node_exporter:disk:write:mb:rate &gt; 60
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 写入字节数 高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-filefd-allocated-percent-high
      expr:  node_exporter:filefd_allocated:percent &gt; 80
      for: 10m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 打开文件描述符 高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-network-netin-error-rate-high
      expr:  node_exporter:network:netin:error:rate &gt; 4
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 包进入的错误速率 高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;

    - alert: node-exporter-network-netin-packet-rate-high
      expr:  node_exporter:network:netin:packet:rate &gt; 35000
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 包进入速率 高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-network-netout-packet-rate-high
      expr:  node_exporter:network:netout:packet:rate &gt; 35000
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 包流出速率 高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-network-tcp-total-count-high
      expr:  node_exporter:network:tcp:total:count &gt; 40000
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} tcp连接数量 高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-process-zoom-total-count-high
      expr:  node_exporter:process:zoom:total:count &gt; 10
      for: 10m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} 僵死进程数量 高于 {{ $value }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;


    - alert: node-exporter-time-offset-high
      expr:  node_exporter:time:offset &gt; 0.03
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: {{ $labels.instance }} {{ $labels.desc }}  {{ $value }} {{ $labels.unit }}&quot;
        description: &quot;&quot;
        value: &quot;{{ $value }}&quot;
        instance: &quot;{{ $labels.instance }}&quot;
</code></pre>
<h3 id="添加告警模板">添加告警模板</h3>
<pre><code class="language-bash">mkdir  template
vim template/default-monitor.tmpl
</code></pre>
<pre><code class="language-tmpl">{{ define &quot;default-monitor.html&quot; }}
{{ range .Alerts }}
=========start==========&lt;br&gt;
告警程序: prometheus_alert &lt;br&gt;
告警级别: {{ .Labels.severity }} 级 &lt;br&gt;
告警类型: {{ .Labels.alertname }} &lt;br&gt;
故障主机: {{ .Labels.instance }} &lt;br&gt;
告警主题: {{ .Annotations.summary }} &lt;br&gt;
告警详情: {{ .Annotations.description }} &lt;br&gt;
触发时间: {{ .StartsAt.Format &quot;2019-08-04 16:58:15&quot; }} &lt;br&gt;
=========end==========&lt;br&gt;
{{ end }}
{{ end }}
</code></pre>
<h2 id="编写docker-compose文件">编写docker-compose文件</h2>
<p>vim    docker-compose-monitor.yml</p>
<pre><code class="language-yaml">version: '2'

networks:
    monitor:
        driver: bridge

services:
  prometheus:
    image: prom/prometheus:v2.16.0
    container_name: prometheus
    restart: always
    ports:
     - 9090:9090
    volumes:
     - /bsn/prometheus/prometheus:/prometheus
     - /bsn/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
     - /bsn/prometheus/alert/alert.rules:/usr/local/prometheus/rules/alert.rules
     - /etc/localtime:/etc/localtime
    command:
     - '--config.file=/etc/prometheus/prometheus.yml'
     - '--storage.tsdb.path=/prometheus/'
     - '--storage.tsdb.retention.time=90d'
    depends_on:
     - alertmanager
  grafana:
    image: grafana/grafana:6.4.2
    container_name: grafana
    restart: always
    volumes:
     - /bsn/prometheus/grafana:/var/lib/grafana
     - /bsn/prometheus/grafana/grafana.ini:/etc/grafana/grafana.ini
     - /etc/localtime:/etc/localtime
    ports:
     - 3000:3000
    depends_on:
     - prometheus
  alertmanager:
    image: prom/alertmanager:v0.21.0-rc.0
    container_name: alertmanager
    volumes:
      - /bsn/prometheus/alert/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - /bsn/prometheus/alert/email.tmpl:/etc/alertmanager/template/email.tmpl
      - /etc/localtime:/etc/localtime
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
    ports:
      - 9093:9093
    restart: always

    node-exporter:
        image: quay.io/prometheus/node-exporter
        container_name: node-exporter
        hostname: $HOSTNAME
        restart: always
        ports:
            - &quot;9100:9100&quot;
        volumes:
          - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro
          - /proc:/host/proc:ro
          - /sys:/host/sys:ro
          - /:/rootfs:ro
        restart: always
        command:
          - '--path.procfs=/host/proc'
          - '--path.sysfs=/host/sys'
          - '--path.rootfs=/rootfs'

    cadvisor:
        image: google/cadvisor:latest
        container_name: cadvisor
        hostname: cadvisor
        restart: always
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:rw
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro
        ports:
            - &quot;8080:8080&quot;

</code></pre>
<h2 id="启动docker-compose">启动docker-compose</h2>
<pre><code class="language-bash">#启动容器：
docker-compose -f /usr/local/src/config/docker-compose-monitor.yml up -d
#删除容器：
docker-compose -f /usr/local/src/config/docker-compose-monitor.yml down
#重启容器：
docker restart id
</code></pre>
<p>在其他节点分别启动cadvisor和node-exporter容器</p>
<pre><code class="language-yaml">version: '3'

services:
    node-exporter:
        image: quay.io/prometheus/node-exporter
        container_name: node-exporter
        hostname: $HOSTNAME
        restart: always
        ports:
            - &quot;9100:9100&quot;
        volumes:
          - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro
          - /proc:/host/proc:ro
          - /sys:/host/sys:ro
          - /:/rootfs:ro
        restart: always
        command:
          - '--path.procfs=/host/proc'
          - '--path.sysfs=/host/sys'
          - '--path.rootfs=/rootfs'
    cadvisor:
        image: google/cadvisor:latest
        container_name: cadvisor
        hostname: cadvisor
        restart: always
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:rw
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro
        ports:
            - &quot;8080:8080&quot;
</code></pre>
<p><strong>容器启动如下：</strong><br>
<img src="https://chriswsq.github.io/post-images/1599121054830.png" alt="" loading="lazy"></p>
<p><strong>prometheus targets界面如下：</strong><br>
<img src="https://chriswsq.github.io/post-images/1599121262766.png" alt="" loading="lazy"></p>
<blockquote>
<p>备注：如果State为Down，应该是防火墙问题，参考下面防火墙配置。</p>
</blockquote>
<p><strong>prometheus targets界面如下：</strong><br>
<img src="https://chriswsq.github.io/post-images/1599121408543.png" alt="" loading="lazy"></p>
<blockquote>
<p>备注：如果没有数据，同步下时间。</p>
</blockquote>
<h2 id="配置grafana">配置grafana</h2>
<h3 id="添加prometheus数据源">添加Prometheus数据源</h3>
<figure data-type="image" tabindex="1"><img src="https://chriswsq.github.io/post-images/1599121507210.png" alt="" loading="lazy"></figure>
<h3 id="配置dashboards">配置dashboards</h3>
<p><strong>说明：可以用自带模板，也可以去https://grafana.com/dashboards，下载对应的模板。</strong></p>
<p>添加监控服务器模板 此处用的模板id是   8919   也可使用（1860）</p>
<p><img src="https://chriswsq.github.io/post-images/1599121616143.png" alt="" loading="lazy"><br>
<img src="https://chriswsq.github.io/post-images/1599121699226.png" alt="" loading="lazy"><br>
<img src="https://chriswsq.github.io/post-images/1599121761143.png" alt="" loading="lazy"></p>
<p>添加监控容器模板   此处用  893   也可用（8321）</p>
<figure data-type="image" tabindex="2"><img src="https://chriswsq.github.io/post-images/1599122084044.png" alt="" loading="lazy"></figure>
<p>也可用综合的 9276</p>
<h2 id="告警">告警</h2>
<p>停止192.168.40.7 的 cadvisor和node-exporter容器<br>
<img src="https://chriswsq.github.io/post-images/1599122289244.png" alt="" loading="lazy"></p>
<p>收到告警邮件<br>
<img src="https://chriswsq.github.io/post-images/1599122330270.png" alt="" loading="lazy"></p>
<blockquote>
<p>注： 如果日期有问题则将告警模板的触发时间参数改为 <code>{{ .StartsAt.Format &quot;2019-08-04 16:58:15&quot; }} &lt;br&gt;</code> 即可。</p>
</blockquote>
<p>参考博客：<br>
https://juejin.im/post/6844903809517371406<br>
https://blog.csdn.net/w342164796/article/details/105079231/<br>
https://blog.csdn.net/aixiaoyang168/article/details/98474494</p>
</div>
                              <div class="mdui-divider mdui-m-t-3"></div>
                              <div class="mdui-row-xs-2 mdui-m-t-2">
  <div class="mdui-col"> <div class="mdui-text-left"><a href="https://chriswsq.github.io/post/ji-yi-ci-fu-wu-qi-nei-cun-guo-gao-wen-ti/">记一次服务器内存过高问题</a></div></div>
 <div class="mdui-col"><div class="mdui-text-right "><a href="https://chriswsq.github.io/post/k8s-ru-he-guan-lian-pvc-dao-te-ding-de-pv/">k8s 如何关联pvc到特定的pv?</a></div> </div>
                                </div>
                                <div class="mdui-divider mdui-m-t-2"></div>
   
 <script src="https://chriswsq.github.io/media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',

            app_id: 'nCwKjHbRmhxBO6Dl20UfM5yw-gzGzoHsz',


            app_key: 'DiIo4l1dsGeJ9VKtPoGOjfN5',


            placeholder: '没事儿说两句',
            
            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })

    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                         </article>
                 <div class="toc-container mdui-float-right">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">基本原理</a></li>
<li><a href="#%E7%9B%B8%E5%85%B3%E7%BB%84%E4%BB%B6">相关组件</a></li>
<li><a href="#%E5%AE%89%E8%A3%85docker-docker-compose">安装docker、docker-compose</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85docker">安装docker</a></li>
<li><a href="#%E5%AE%89%E8%A3%85docker-compose">安装docker-compose</a></li>
</ul>
</li>
<li><a href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">添加配置文件</a>
<ul>
<li><a href="#%E6%B7%BB%E5%8A%A0prometheusyml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">添加prometheus.yml配置文件</a></li>
<li><a href="#%E6%B7%BB%E5%8A%A0%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">添加邮件告警配置文件</a></li>
<li><a href="#%E6%B7%BB%E5%8A%A0%E6%8A%A5%E8%AD%A6%E8%A7%84%E5%88%99">添加报警规则</a></li>
<li><a href="#%E6%B7%BB%E5%8A%A0%E5%91%8A%E8%AD%A6%E6%A8%A1%E6%9D%BF">添加告警模板</a></li>
</ul>
</li>
<li><a href="#%E7%BC%96%E5%86%99docker-compose%E6%96%87%E4%BB%B6">编写docker-compose文件</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8docker-compose">启动docker-compose</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEgrafana">配置grafana</a>
<ul>
<li><a href="#%E6%B7%BB%E5%8A%A0prometheus%E6%95%B0%E6%8D%AE%E6%BA%90">添加Prometheus数据源</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEdashboards">配置dashboards</a></li>
</ul>
</li>
<li><a href="#%E5%91%8A%E8%AD%A6">告警</a></li>
</ul>
</li>
</ul>

              </div>

                        </div>
                 </div>
          
        </div>
        <script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.post-neirong img',
                    'exclude' : '.vsmile-icons img , .song-links-item img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>
        <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                      </ul>
                    </nav>
                  <div class="copyright">
                      <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
                  </div>
              </footer>
    </body>
</html>