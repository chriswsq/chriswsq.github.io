<html>
      <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <meta name="referrer" content="never">
        <title>elk用户认证问题 | chris&#39;wang</title>
        <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
        <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://chriswsq.github.io/styles/main.css">
          <script src="https://chriswsq.github.io/media/scripts/mdui.min.js"></script>
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://fonts.googleapis.com/css?family=Dancing+Script|Ma+Shan+Zheng&display=swap" rel="stylesheet">
        <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
        <script src="https://chriswsq.github.io/media/scripts/script.js"></script>
        <script >hljs.initHighlightingOnLoad();</script>
        

    </head>
    <body class="mdui-theme-primary-purple mdui-theme-accent-purple">
        <header class="index-img mdui-m-b-3" >
                          <button class="mdui-btn  mdui-btn-icon mdui-btn-dense mdui-color-theme-500 mdui-ripple yinying mdui-m-t-1 mdui-m-l-1" mdui-menu="{target: '#demo-attr-cascade'}"><i class="mdui-icon material-icons">&#xe5d2;</i></button>
                <ul class="mdui-menu" id="demo-attr-cascade">
                
                        <li class="mdui-menu-item">
                          <a href="/" class="mdui-ripple">首页</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/archives" class="mdui-ripple">归档</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/tags" class="mdui-ripple">标签</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/post/about" class="mdui-ripple">关于</a>
                        </li>
                
                      </ul>

        </header>
        <div class="mdui-container post">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                         <article class="mdui-shadow-10 mdui-p-a-2 post-list">
                           <div class="mdui-typo-display-1 mdui-m-b-3">elk用户认证问题</div>
                           <a  class="index-list-biaoqian ">2020-08-27</a>
                           <div class="mdui-typo mdui-m-t-3 post-neirong"><p>elk7+的用户认证免费了，不过没有集成在安装包里，还需要自己再进行一些操作，在此记录下自己再配置用户认证时遇到的问题</p>
<!-- more -->
<h2 id="开启安全功能">开启安全功能</h2>
<p>首先在es配置文件中开启安全功能</p>
<pre><code>.....

xpack.security.enabled: true
xpack.security.transport.ssl.enabled
</code></pre>
<p>然后重启es服务</p>
<h2 id="生成证书配置node间ssl通信">生成证书，配置Node间SSL通信</h2>
<h3 id="创建ca证书">创建ca证书</h3>
<pre><code>$ bin/elasticsearch-certutil ca -v
</code></pre>
<p>一路回车即可</p>
<p>默认的CA证书存放在$ES_HOME 目录中</p>
<p>这个命令生成格式为PKCS#12名称为 elastic-stack-ca.p12 的keystore文件，包含CA证书和私钥。</p>
<h3 id="创建节点间认证用的证书">创建节点间认证用的证书</h3>
<pre><code>$ ./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 
</code></pre>
<p>一路回车即可</p>
<h3 id="配置es节点使用这个证书">配置ES节点使用这个证书</h3>
<pre><code>$ mkdir config/certs
$ mv elastic-* config/certs/
ll config/certs/

-rw------- 1 elasticsearch root 3443 Jun  9 15:22 elastic-certificates.p12
-rw------- 1 elasticsearch root 2527 Jun  9 15:22 elastic-stack-ca.p12
</code></pre>
<p>拷贝这个目录到所有的ES节点中<br>
config/certs 目录中不需要拷贝CA证书文件，只拷贝cert文件即可</p>
<p>配置elasticsearch.yml配置文件，注意所有的node节点都需要配置，这里的配置是使用PKCS#12格式的证书。</p>
<pre><code>$ vim  config/elasticsearch.yml
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate #认证方式使用证书
xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12
</code></pre>
<h2 id="测试能够正常启动了-好了我们再来继续之前的生成密码在随意一台节点即可">测试能够正常启动了。好了，我们再来继续之前的生成密码：在随意一台节点即可。</h2>
<p>生成密码有两个命令，一个为自动生成，一个为手动生成</p>
<p>自动<br>
<code>bin/elasticsearch-setup-passwords auto</code><br>
手动<br>
<code>bin/elasticsearch-setup-passwords interactive</code></p>
<p>这里我们选择自动</p>
<pre><code>[root@elasticsearch1 elasticsearch]# bin/elasticsearch-setup-passwords auto
Initiating the setup of passwords for reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.
The passwords will be randomly generated and printed to the console.
Please confirm that you would like to continue [y/N]y


Changed password for user apm_system
PASSWORD apm_system = EKPbqziKu4v3P0MYoYIJ

Changed password for user kibana
PASSWORD kibana = 48Sf7tIFArn4rmyMW2x4

Changed password for user logstash_system
PASSWORD logstash_system = O09XtxP495uNRxHRZxtC

Changed password for user beats_system
PASSWORD beats_system = ULC810uP0sVCAKhbwxvE

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = zqnO9YBFsoRu5QIsgOi6

Changed password for user elastic
PASSWORD elastic = d27DuDQjTChIdv3sE8oI

</code></pre>
<p>查看集群节点数量：</p>
<pre><code>[root@test-1 conf]# curl -u elastic 192.168.154.6:9200/_cat/nodes
Enter host password for user 'elastic':
10.0.0.67 32 88 1 0.12 0.08 0.43 ilmr   - node-1
10.0.0.92 14 80 1 0.12 0.07 0.22 dilmrt * node-2
10.0.0.93 12 79 1 0.00 0.03 0.24 dilmrt - node-3
</code></pre>
<h2 id="kibana的安装配置">kibana的安装配置</h2>
<h3 id="编辑配置文件">编辑配置文件</h3>
<pre><code>$ cat kibana/config/kibana.yml |grep -Ev &quot;^$|^#&quot;
server.port: 5601
server.host: &quot;0.0.0.0&quot;
server.name: &quot;mykibana&quot;
elasticsearch.hosts: [&quot;http://localhost:9200&quot;]
kibana.index: &quot;.kibana&quot;
elasticsearch.username: &quot;kibana&quot;
elasticsearch.password: &quot;UKuHceHWudloJk9NvHlX&quot;
# i18n.locale: &quot;en&quot;
i18n.locale: &quot;zh-CN&quot;
xpack.security.encryptionKey: Hz*9yFFaPejHvCkhT*ddNx%WsBgxVSCQ
</code></pre>
<h3 id="页面访问kibana">页面访问kibana</h3>
<figure data-type="image" tabindex="1"><img src="/images/elk%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/kibana-login.jpg" alt="" loading="lazy"></figure>
<p>输入上面生成的管理员elastic的用户和密码，就可以登陆了，我们查看一下license许可吧：<br>
<img src="/images/elk%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/kibana-basic.jpg" alt="" loading="lazy"></p>
<p>一个使用永不过期的Basic许可的免费License，开启了基本的Auth认证和集群间SSL/TLS 认证的Elasticsearch集群就创建完毕了。</p>
<p>等等，你有没有想过Kibana的配置文件中使用着明文的用户名密码，这里只能通过LInux的权限进行控制了，有没有更安全的方式呢，有的，就是keystore。</p>
<h3 id="kibana-keystore-安全配置">kibana keystore 安全配置</h3>
<p><a href="https://www.elastic.co/guide/en/kibana/7.7/secure-settings.html">参考官方</a></p>
<p>查看<code>kibana-keystore</code>命令帮助：</p>
<pre><code>$ ./bin/kibana-keystore --help
Usage: bin/kibana-keystore [options] [command]

A tool for managing settings stored in the Kibana keystore

Options:
  -V, --version           output the version number
  -h, --help              output usage information

Commands:
  create [options]        Creates a new Kibana keystore
  list [options]          List entries in the keystore
  add [options] &lt;key&gt;     Add a string setting to the keystore
  remove [options] &lt;key&gt;  Remove a setting from the keystore

</code></pre>
<p>首先我们创建keystore：</p>
<pre><code>$ bin/kibana-keystore create
Created Kibana keystore in /opt/elk74/kibana-7.4.2-linux-x86_64/data/kibana.keystore # 默认存放位置
</code></pre>
<p>增加配置：</p>
<p>我们要吧kibana.yml 配置文件中的敏感信息，比如：elasticsearch.username 和 elasticsearch.password，给隐藏掉，或者直接去掉；</p>
<p>所以这里我们增加两个配置：分别是elasticsearch.password 和 elasticsearch.username:</p>
<pre><code># 查看add的命令帮助：
$ ./bin/kibana-keystore add --help
Usage: add [options] &lt;key&gt;

Add a string setting to the keystore

Options:
  -f, --force   overwrite existing setting without prompting
  -x, --stdin   read setting value from stdin
  -s, --silent  prevent all logging
  -h, --help    output usage information

# 创建elasticsearch.username这个key：注意名字必须是kibana.yml中的key
$ ./bin/kibana-keystore add elasticsearch.username
Enter value for elasticsearch.username: ******  # 输入key对应的value，这里是kibana连接es的账号：kibana

# 创建elasticsearch.password这个key
$ ./bin/kibana-keystore add elasticsearch.password
Enter value for elasticsearch.password: ******************** # 输入对应的密码：UKuHceHWudloJk9NvHlX
</code></pre>
<p>好了，我们把kibana.yml配置文件中的这两项配置删除即可，然后直接启动kibana，kibana会自动已用这两个配置的。</p>
<p>最终的kibana.yml配置如下：</p>
<pre><code>server.port: 5601
server.host: &quot;0.0.0.0&quot;
server.name: &quot;mykibana&quot;
elasticsearch.hosts: [&quot;http://localhost:9200&quot;]
kibana.index: &quot;.kibana&quot;
# i18n.locale: &quot;en&quot;
i18n.locale: &quot;zh-CN&quot;
xpack.security.encryptionKey: Hz*9yFFaPejHvCkhT*ddNx%WsBgxVSCQ
</code></pre>
<p>这样配置文件中就不会出现敏感信息了，达到了更高的安全性。</p>
<p>类似的Keystore方式不只是Kibana支持，ELK的产品都是支持的。</p>
<p><strong>注意：两个证书文件属主须是启动用户，certs权限为744即可，权限不够会报错,其他节点权限也一样</strong></p>
<pre><code>elk_elasticsearch1.1.rqtnwnm1sqzw@test-1    | uncaught exception in thread [main]
elk_elasticsearch1.1.rqtnwnm1sqzw@test-1    | ElasticsearchSecurityException[failed to load SSL configuration [xpack.security.transport.ssl]]; nested: ElasticsearchException[failed to initialize SSL TrustManager - not permitted to read truststore file [/usr/share/elasticsearch/config/certs/elastic-certificates.p12]]; nested: AccessDeniedException[/usr/share/elasticsearch/config/certs/elastic-certificates.p12];
elk_elasticsearch1.1.jp9k598g34hq@test-1    | &quot;... 6 more&quot;] }
elk_elasticsearch1.1.yk71h6aom47z@test-1    | &quot;at org.elasticsearch.node.Node.&lt;init&gt;(Node.java:481) ~[elasticsearch-7.7.0.jar:7.7.0]&quot;,
elk_elasticsearch1.1.w26656n32a86@test-1    | &quot;... 6 more&quot;] }
elk_elasticsearch1.1.w26656n32a86@test-1    | ElasticsearchSecurityException[failed to load SSL configuration [xpack.security.transport.ssl]]; nested: ElasticsearchException[failed to initialize SSL TrustManager - not permitted to read truststore file [/usr/share/elasticsearch/config/certs/elastic-certificates.p12]]; nested: AccessDeniedException[/usr/share/elasticsearch/config/certs/elastic-certificates.p12];
elk_elasticsearch1.1.rqtnwnm1sqzw@test-1    | Likely root cause: java.nio.file.AccessDeniedException: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
elk_elasticsearch1.1.jp9k598g34hq@test-1    | ElasticsearchSecurityException[failed to load SSL configuration [xpack.security.transport.ssl]]; nested: ElasticsearchException[failed to initialize SSL TrustManager - not permitted to read truststore file [/usr/share/elasticsearch/config/certs/elastic-certificates.p12]]; nested: AccessDeniedException[/usr/share/elasticsearch/config/certs/elastic-certificates.p12];
</code></pre>
<p><a href="https://knner.wang/2019/11/26/install-elasticsearch-cluster-7-4.html">参考自</a></p>
<h2 id="logstash配置">logstash配置</h2>
<p><a href="https://www.elastic.co/cn/blog/configuring-ssl-tls-and-https-to-secure-elasticsearch-kibana-beats-and-logstash">参考</a></p>
</div>
                              <div class="mdui-divider mdui-m-t-3"></div>
                              <div class="mdui-row-xs-2 mdui-m-t-2">
  <div class="mdui-col"> <div class="mdui-text-left"><a href="https://chriswsq.github.io/post/logstash-pei-zhi/">logstash配置</a></div></div>
 <div class="mdui-col"><div class="mdui-text-right "><a href="https://chriswsq.github.io/post/elk-gao-jing-zhi-elastalert-bu-shu-ji-pei-zhi/">ELK告警之elastalert部署及配置</a></div> </div>
                                </div>
                                <div class="mdui-divider mdui-m-t-2"></div>
   
 <script src="https://chriswsq.github.io/media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',

            app_id: 'nCwKjHbRmhxBO6Dl20UfM5yw-gzGzoHsz',


            app_key: 'DiIo4l1dsGeJ9VKtPoGOjfN5',


            placeholder: '没事儿说两句',
            
            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })

    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                         </article>
                 <div class="toc-container mdui-float-right">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%BC%80%E5%90%AF%E5%AE%89%E5%85%A8%E5%8A%9F%E8%83%BD">开启安全功能</a></li>
<li><a href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AEnode%E9%97%B4ssl%E9%80%9A%E4%BF%A1">生成证书，配置Node间SSL通信</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BAca%E8%AF%81%E4%B9%A6">创建ca证书</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%8A%82%E7%82%B9%E9%97%B4%E8%AE%A4%E8%AF%81%E7%94%A8%E7%9A%84%E8%AF%81%E4%B9%A6">创建节点间认证用的证书</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEes%E8%8A%82%E7%82%B9%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E8%AF%81%E4%B9%A6">配置ES节点使用这个证书</a></li>
</ul>
</li>
<li><a href="#%E6%B5%8B%E8%AF%95%E8%83%BD%E5%A4%9F%E6%AD%A3%E5%B8%B8%E5%90%AF%E5%8A%A8%E4%BA%86-%E5%A5%BD%E4%BA%86%E6%88%91%E4%BB%AC%E5%86%8D%E6%9D%A5%E7%BB%A7%E7%BB%AD%E4%B9%8B%E5%89%8D%E7%9A%84%E7%94%9F%E6%88%90%E5%AF%86%E7%A0%81%E5%9C%A8%E9%9A%8F%E6%84%8F%E4%B8%80%E5%8F%B0%E8%8A%82%E7%82%B9%E5%8D%B3%E5%8F%AF">测试能够正常启动了。好了，我们再来继续之前的生成密码：在随意一台节点即可。</a></li>
<li><a href="#kibana%E7%9A%84%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE">kibana的安装配置</a>
<ul>
<li><a href="#%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">编辑配置文件</a></li>
<li><a href="#%E9%A1%B5%E9%9D%A2%E8%AE%BF%E9%97%AEkibana">页面访问kibana</a></li>
<li><a href="#kibana-keystore-%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE">kibana keystore 安全配置</a></li>
</ul>
</li>
<li><a href="#logstash%E9%85%8D%E7%BD%AE">logstash配置</a></li>
</ul>
</li>
</ul>

              </div>

                        </div>
                 </div>
          
        </div>
        <script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.post-neirong img',
                    'exclude' : '.vsmile-icons img , .song-links-item img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>
        <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                      </ul>
                    </nav>
                  <div class="copyright">
                      <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
                  </div>
              </footer>
    </body>
</html>