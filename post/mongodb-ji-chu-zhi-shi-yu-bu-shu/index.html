<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>mongodb基础知识与部署 | chris&#39;wang</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://chriswsq.github.io/favicon.ico?v=1610353276596">
<link rel="stylesheet" href="https://chriswsq.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="我们在安装完mongodb之后，默认是没有开启权限认证的， 但是我们在生产环境权限认证是必不可少的
命令行部署
1. 创建用户
启动mongo shell
我们先创建个管理员账号（该账号可以对所有数据库进行用户管理）
root@2613c6..." />
    <meta name="keywords" content="databases" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://chriswsq.github.io">
        <img src="https://chriswsq.github.io/images/avatar.png?v=1610353276596" class="site-logo">
        <h1 class="site-title">chris&#39;wang</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      当你觉得无所事事时，那你就是在虚度光阴
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://chriswsq.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">mongodb基础知识与部署</h2>
            <div class="post-date">2021-01-11</div>
            
            <div class="post-content" v-pre>
              <p>我们在安装完mongodb之后，默认是没有开启权限认证的， 但是我们在生产环境权限认证是必不可少的</p>
<h1 id="命令行部署">命令行部署</h1>
<h2 id="1-创建用户">1. 创建用户</h2>
<p>启动mongo shell<br>
我们先创建个管理员账号（该账号可以对所有数据库进行用户管理）</p>
<pre><code class="language-bash">root@2613c68bd252:/# mongo     #进入命令行
MongoDB shell version v4.2.6
connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb
Implicit session: session { &quot;id&quot; : UUID(&quot;4b9dd82a-5098-41f1-a265-45bcff0ad0e3&quot;) }
MongoDB server version: 4.2.6
&gt; use admin
switched to db admin
&gt; db.createUser(
... {
...   user: &quot;admin&quot;,
...   pwd: &quot;123456&quot;,
...   roles: [ { role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot;} ]
... }
... )
Successfully added user: {
        &quot;user&quot; : &quot;admin&quot;,
        &quot;roles&quot; : [
                {
                        &quot;role&quot; : &quot;userAdminAnyDatabase&quot;,
                        &quot;db&quot; : &quot;admin&quot;
                }
        ]
}
</code></pre>
<h2 id="2-开启权限认证">2. 开启权限认证</h2>
<p>修改conf文件</p>
<pre><code class="language-conf">maxConns = 1000000
fork = false
port = 27017
pidfilepath = /var/run/mongodb_27017.pid
dbpath = /var/lib/mongodb/
logpath = /var/log/mongodb/mongodb.log
logappend = true
bind_ip  = 0.0.0.0
auth = true                         #启动认证模块
journal = true
</code></pre>
<p>重新启动即可</p>
<h1 id="docker部署">docker部署</h1>
<h2 id="docker-compose">docker-compose</h2>
<pre><code class="language-yml">version: '2'
services:
  mongodb:
    image: mongo
    ports:
        - 27017:27017
    volumes:
        - &quot;./data/configdb:/data/configdb&quot;
        - &quot;./data/db:/data/db&quot;
    command: mongod --auth
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root       #初始化管理员用户名和密码
      - MONGO_INITDB_ROOT_PASSWORD=123456
    tty: true
</code></pre>
<h2 id="带上mongo-expressweb管理页面">带上mongo-express，web管理页面。</h2>
<pre><code class="language-yml"># Use root/example as user/password credentials
version: '3.1'

services:

  mongo:
    image: mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    # command: [&quot;--bind_ip_all&quot;]
    ports:
      - &quot;27017:27017&quot;

  mongo-express:
    image: mongo-express
    restart: always
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: root
</code></pre>
<p>运行docker ps查看容器是否运行。</p>
<p>进入docker容器并进入mongo命令行。</p>
<pre><code class="language-bash">docker exec -it  test bash
mongo
</code></pre>
<p>此时show dbs无法执行，需要认证。<br>
切换到admin并创建root用户：</p>
<pre><code class="language-bash">use admin
db.createUser({ user: 'admin', pwd: 'admin', roles: [ { role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; } ] })
</code></pre>
<h2 id="3-创建其他的账号">3. 创建其他的账号</h2>
<pre><code class="language-bash">&gt; use admin
switched to db admin
&gt; db.auth(&quot;admin&quot;, &quot;admin&quot;)
1
&gt; db.createUser(
... {
...  user : &quot;my_tester&quot;,
...  pwd : &quot;123456&quot;,
...  roles: [ { role : &quot;readWrite&quot;, db : &quot;test&quot; }  ]
... }
... )
Successfully added user: {
        &quot;user&quot; : &quot;my_tester&quot;,
        &quot;roles&quot; : [
                {
                        &quot;role&quot; : &quot;readWrite&quot;,
                        &quot;db&quot; : &quot;test&quot;
                }
        ]
}
</code></pre>
<h2 id="权限说明基于角色的权限控制">权限说明（基于角色的权限控制）</h2>
<h3 id="数据库用户角色">数据库用户角色</h3>
<p>read: 只读数据权限<br>
readWrite:学些数据权限<br>
<strong>数据库管理角色</strong></p>
<ul>
<li>dbAdmin: 在当前db中执行管理操作的权限</li>
<li>dbOwner: 在当前db中执行任意操作</li>
<li>userADmin: 在当前db中管理user的权限<br>
<strong>备份和还原角色</strong></li>
<li>backup</li>
<li>restore<br>
<strong>夸库角色</strong></li>
<li>readAnyDatabase: 在所有数据库上都有读取数据的权限</li>
<li>readWriteAnyDatabase: 在所有数据库上都有读写数据的权限</li>
<li>userAdminAnyDatabase: 在所有数据库上都有管理user的权限</li>
<li>dbAdminAnyDatabase: 管理所有数据库的权限<br>
<strong>集群管理</strong></li>
<li>clusterAdmin: 管理机器的最高权限</li>
<li>clusterManager: 管理和监控集群的权限</li>
<li>clusterMonitor: 监控集群的权限</li>
<li>hostManager: 管理Server<br>
<strong>超级权限</strong></li>
<li>root: 超级用户</li>
</ul>
<h3 id="52-自定义角色">5.2 自定义角色</h3>
<p>内置角色只能控制User在DB级别上执行的操作，管理员可以创建自定义角色，控制用户在集合级别（Collection-Level）上执行的操作，即，控制User在当前DB的特定集合上执行特定的操作</p>
<h2 id="基本命令">基本命令</h2>
<p><strong>查看创建的用户</strong></p>
<pre><code class="language-bash">show users 或 db.system.users.find() 或 db.runCommand({usersInfo:&quot;userName&quot;})
</code></pre>
<p><strong>修改密码</strong></p>
<pre><code class="language-bash">use admin
db.changeUserPassword(&quot;username&quot;, &quot;xxx&quot;)
</code></pre>
<p><strong>修改密码和用户信息</strong></p>
<pre><code class="language-bash">db.runCommand(
    {
        updateUser:&quot;username&quot;,
        pwd:&quot;xxx&quot;,
        customData:{title:&quot;xxx&quot;}
    }
)
</code></pre>
<p><strong>删除数据库用户</strong></p>
<pre><code class="language-bash">use admin
db.dropUser('user001')
</code></pre>
<p><strong>创建其他数据管理员</strong></p>
<pre><code class="language-bash">// 登录管理员用户
use admin
db.auth('admin','admin')
// 切换至db001数据库
use db001
// ... 増查改删该数据库专有用户
</code></pre>
<h2 id="重要的一步">重要的一步</h2>
<p>启用权限验证(别TM的武装了大半天，大门还一直开着，还抱怨我方防御塔怎么一直被摧毁)</p>
<pre><code class="language-bash">mongo --auth
</code></pre>
<p>或者修改mongo.conf，最后一行添加</p>
<pre><code class="language-bash">#启用权限访问
auth=true
</code></pre>
<p>参考自：https://www.jianshu.com/p/62736bff7e2e</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://chriswsq.github.io/tag/iLCL9rXmm/" class="tag">
                    databases
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://chriswsq.github.io/post/shell-jiao-ben-shu-chu-dai-yan-se-zi-ti/">
                  <h3 class="post-title">
                    shell脚本输出带颜色字体
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>





  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: '',
        owner: '',
        admin: [''],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
